blueprint:
  name: TRV calibration via external temperature (fixed)
  description: Automatically calibrates TRV local temperature to match an external room sensor.
  domain: automation

  input:
    room_temp_sensor:
      name: External room temperature sensor
      selector:
        entity:
          domain: sensor
          device_class: temperature
    trv_climate:
      name: TRV climate device
      selector:
        entity:
          domain: climate
    min_delta_step:
      name: Minimum temperature change (°C) to trigger recalibration
      default: 0.3
      selector:
        number:
          min: 0.1
          max: 1
          step: 0.1
    min_calibration:
      name: Minimum TRV calibration
      default: -5
      selector:
        number:
          min: -10
          max: 0
          step: 0.5
    max_calibration:
      name: Maximum TRV calibration
      default: 5
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
    debug_mode:
      name: Debug mode
      default: false
      selector:
        boolean:

mode: single

trigger:
  - platform: state
    entity_id: !input room_temp_sensor
  - platform: state
    entity_id: !input trv_climate
    attribute: local_temperature

action:
  - variables:
      # Переносим входы в локальные переменные для использования в формулах
      room_sensor: !input room_temp_sensor
      trv_entity: !input trv_climate
      min_cal: !input min_calibration
      max_cal: !input max_calibration
      min_step: !input min_delta_step
      debug: !input debug_mode

      # Рассчитываем значения
      ext_temp: "{{ states(room_sensor) | float(0) }}"
      local_temp: "{{ state_attr(trv_entity, 'local_temperature') | float(0) }}"
      local_delta: "{{ state_attr(trv_entity, 'local_temperature_calibration') | float(0) }}"
      
      # Основная формула калибровки
      new_delta: "{{ (ext_temp - local_temp + local_delta) | clamp(min_cal, max_cal) | round(1) }}"

  # Проверка: стоит ли менять значение (разница больше min_delta_step)
  - condition: template
    value_template: "{{ (new_delta - local_delta) | abs >= min_step | float }}"

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ debug }}"
        sequence:
          - service: persistent_notification.create
            data:
              title: "TRV Calibration Debug"
              message: >
                Sensor: {{ ext_temp }}°C | TRV: {{ local_temp }}°C
                Old offset: {{ local_delta }} | New offset: {{ new_delta }}

  - service: climate.set_temperature_calibration
    target:
      entity_id: !input trv_climate
    data:
      temperature_calibration: "{{ new_delta }}"
