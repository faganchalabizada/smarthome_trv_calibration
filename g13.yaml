blueprint:
  name: Z2M TRV Calibration (with Debug)
  description: Автоматическая калибровка термоголовки через сущность Number (для Zigbee2MQTT)
  domain: automation

  input:
    room_temp_sensor:
      name: Внешний датчик температуры
      description: Датчик, по которому будет равняться термоголовка (например, Xiaomi или Aqara)
      selector:
        entity:
          domain: sensor
          device_class: temperature
    trv_climate:
      name: Термоголовка (Climate)
      description: Основная сущность управления климатом
      selector:
        entity:
          domain: climate
    trv_calibration_number:
      name: Сущность калибровки (Number)
      description: Выберите сущность number.xxx_local_temperature_calibration
      selector:
        entity:
          domain: number
    min_delta_step:
      name: Минимальный порог срабатывания
      description: Не калибровать, если разница меньше этого значения (экономит батарейки)
      default: 0.3
      selector:
        number:
          min: 0.1
          max: 1.0
          step: 0.1
    min_calibration:
      name: Минимальный предел калибровки
      default: -5
      selector:
        number:
          min: -10
          max: 0
          step: 0.5
    max_calibration:
      name: Максимальный предел калибровки
      default: 5
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
    debug_mode:
      name: Включить отладку
      description: Создавать уведомление при каждой попытке калибровки
      default: false
      selector:
        boolean:

mode: single

trigger:
  - platform: state
    entity_id: !input room_temp_sensor
  - platform: state
    entity_id: !input trv_climate
    attribute: local_temperature

action:
  - variables:
      # Назначаем переменные из входов
      room_sensor: !input room_temp_sensor
      trv_entity: !input trv_climate
      cal_number: !input trv_calibration_number
      min_step: !input min_delta_step
      min_limit: !input min_calibration
      max_limit: !input max_calibration
      debug: !input debug_mode

      # Получаем текущие показатели
      t_room: "{{ states(room_sensor) | float(0) }}"
      t_trv: "{{ state_attr(trv_entity, 'local_temperature') | float(0) }}"
      current_offset: "{{ states(cal_number) | float(0) }}"

      # ФОРМУЛА
      calculated_offset: "{{ (t_room - t_trv + current_offset) | round(1) }}"
      final_offset: "{{ calculated_offset | clamp(min_limit, max_limit) }}"
      
      # Разница для условия
      difference: "{{ (final_offset - current_offset) | abs }}"

  # Блок уведомления (Debug)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ debug }}"
        sequence:
          - service: persistent_notification.create
            data:
              title: "Отладка калибровки TRV"
              message: >
                Датчик комнаты: {{ t_room }}°C
                Термоголовка: {{ t_trv }}°C
                Текущий оффсет: {{ current_offset }}
                Новый расчетный оффсет: {{ final_offset }}
                Изменение: {{ (final_offset - current_offset) | round(2) }}
                Порог срабатывания: {{ min_step }}
                Результат: {{ 'ОБНОВЛЯЮ' if difference >= min_step|float else 'ИГНОРИРУЮ' }}

  # Проверяем: нужно ли обновлять?
  - condition: template
    value_template: "{{ difference >= min_step | float }}"

  # Устанавливаем новое значение калибровки
  - service: number.set_value
    target:
      entity_id: !input trv_calibration_number
    data:
      value: "{{ final_offset }}"
