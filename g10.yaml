blueprint:
  name: TRV calibration via Number entity (Fixed)
  description: Calibrates TRV using a specific number entity for offset.
  domain: automation

  input:
    room_temp_sensor:
      name: External room temperature sensor
      selector:
        entity:
          domain: sensor
          device_class: temperature
    trv_climate:
      name: TRV climate device
      selector:
        entity:
          domain: climate
    trv_calibration_number:
      name: TRV Calibration Number Entity
      description: Select the number.xxx_local_temperature_calibration entity
      selector:
        entity:
          domain: number
    min_delta_step:
      name: Minimum temperature change (°C)
      default: 0.3
      selector:
        number:
          min: 0.1
          max: 1
          step: 0.1
    min_calibration:
      name: Minimum TRV calibration
      default: -5
      selector:
        number:
          min: -10
          max: 0
          step: 0.5
    max_calibration:
      name: Maximum TRV calibration
      default: 5
      selector:
        number:
          min: 0
          max: 10
          step: 0.5

mode: single

trigger:
  - platform: state
    entity_id: !input room_temp_sensor
  - platform: state
    entity_id: !input trv_climate
    attribute: local_temperature

action:
  - variables:
      # Входы
      room_sensor: !input room_temp_sensor
      trv_entity: !input trv_climate
      cal_number_entity: !input trv_calibration_number
      min_cal: !input min_calibration
      max_cal: !input max_calibration
      min_step: !input min_delta_step

      # Данные
      ext_temp: "{{ states(room_sensor) | float(0) }}"
      local_temp: "{{ state_attr(trv_entity, 'local_temperature') | float(0) }}"
      # Берем текущую калибровку прямо из сущности number
      local_delta: "{{ states(cal_number_entity) | float(0) }}"
      
      # Расчет: Новая дельта = (Внешняя Т - Локальная Т термоголовки) + Текущая дельта
      new_delta: "{{ (ext_temp - local_temp + local_delta) | clamp(min_cal, max_cal) | round(1) }}"

  # Проверяем, нужно ли менять значение
  - condition: template
    value_template: "{{ (new_delta - local_delta) | abs >= min_step | float }}"

  # Используем правильный сервис для сущности number
  - service: number.set_value
    target:
      entity_id: !input trv_calibration_number
    data:
      value: "{{ new_delta }}"
